SET NOCOUNT ON
SET DATEFORMAT dmy

USE master
GO

IF EXISTS (SELECT name FROM master.dbo.sysdatabases WHERE name = 'DB_ES2_LIBRO')  
	DROP DATABASE [DB_ES2_LIBRO]
GO

CREATE database [DB_ES2_LIBRO]
GO
USE [DB_ES2_LIBRO]
GO

/*
Creo gli script delle tabelle
*/

CREATE TABLE CICLISTA(
NOMECICLISTA VARCHAR(45) NOT NULL PRIMARY KEY,
NAZIONALITà VARCHAR(45) NOT NULL,
ETà INT NOT NULL)

CREATE TABLE GARA(
NOMECORSA VARCHAR(45) NOT NULL,
ANNO INT NOT NULL,
PARTENZA VARCHAR(45) NOT NULL,
ARRIVO VARCHAR(45) NOT NULL,
PRIMARY KEY(NOMECORSA,ANNO))
GO

CREATE TABLE PARTECIPA(
NOMECORSA VARCHAR(45) NOT NULL,
ANNO INT NOT NULL,
NOMECICLISTA VARCHAR(45) NOT NULL FOREIGN KEY REFERENCES CICLISTA,
POSIZIONE CHAR(20),
FOREIGN KEY(NOMECORSA,ANNO) REFERENCES GARA,
PRIMARY KEY(NOMECORSA,ANNO,NOMECICLISTA))
GO

/*
Inserisco dei dati nelle tabelle
*/

INSERT INTO CICLISTA VALUES('BRADLEY WIGGINS','UK','28')
INSERT INTO CICLISTA VALUES('CRISTOPHER FROOME','UK','25')
INSERT INTO CICLISTA VALUES('VINCENZO NIBALI','ITALY','29')
INSERT INTO CICLISTA VALUES('NICOLAS ROCHE','FRANCE','31')
INSERT INTO CICLISTA VALUES('MICHELE SCARPONI','ITALY','33')
INSERT INTO CICLISTA VALUES('IVAN BASSO','ITALY','28')
INSERT INTO CICLISTA VALUES('MARIO ROSSI','ITALY','30')
INSERT INTO CICLISTA VALUES('RAFAEL VALLS FERRI','SPAIN','23')


INSERT INTO GARA VALUES('Milano-Sanremo','2013','MILANO','SANREMO')
INSERT INTO GARA VALUES('Milano-Sanremo','2012','MILANO','SANREMO')
INSERT INTO GARA VALUES('Giro','2012','BERGAMO','LECCO')
INSERT INTO GARA VALUES('Giro','2013','BERGAMO','LECCO')
INSERT INTO GARA VALUES('Giro','2011','MILANO','FIRENZE')
INSERT INTO GARA VALUES('Giro','2010','BRUGES','PARIGI')


INSERT INTO PARTECIPA VALUES('Milano-Sanremo','2012','MARIO ROSSI','PRIMO')
INSERT INTO PARTECIPA VALUES('Milano-Sanremo','2012','BRADLEY WIGGINS','SECONDO')
INSERT INTO PARTECIPA VALUES('Milano-Sanremo','2012','IVAN BASSO','R')

INSERT INTO PARTECIPA VALUES('Milano-Sanremo','2013','BRADLEY WIGGINS','PRIMO')
INSERT INTO PARTECIPA VALUES('Milano-Sanremo','2013','MICHELE SCARPONI','SECONDO')
INSERT INTO PARTECIPA VALUES('Milano-Sanremo','2013','NICOLAS ROCHE','QUARTO')
INSERT INTO PARTECIPA VALUES('Milano-Sanremo','2013','RAFAEL VALLS FERRI','TERZO')
INSERT INTO PARTECIPA VALUES('Milano-Sanremo','2013','MARIO ROSSI','R')

INSERT INTO PARTECIPA VALUES('Giro','2012','MARIO ROSSI','PRIMO')
INSERT INTO PARTECIPA VALUES('Giro','2012','BRADLEY WIGGINS','SECONDO')
INSERT INTO PARTECIPA VALUES('Giro','2012','IVAN BASSO','R')
INSERT INTO PARTECIPA VALUES('Giro','2012','CRISTOPHER FROOME','R')
INSERT INTO PARTECIPA VALUES('Giro','2012','VINCENZO NIBALI','TERZO')

INSERT INTO PARTECIPA VALUES('Giro','2013','NICOLAS ROCHE','R')
INSERT INTO PARTECIPA VALUES('Giro','2013','MICHELE SCARPONI','SECONDO')
INSERT INTO PARTECIPA VALUES('Giro','2013','VINCENZO NIBALI','PRIMO')

INSERT INTO PARTECIPA VALUES('Giro','2011','IVAN BASSO','R')
INSERT INTO PARTECIPA VALUES('Giro','2011','BRADLEY WIGGINS','PRIMO')
INSERT INTO PARTECIPA VALUES('Giro','2011','MICHELE SCARPONI','SECONDO')

INSERT INTO PARTECIPA VALUES('Giro','2010','RAFAEL VALLS FERRI','TERZO')
INSERT INTO PARTECIPA VALUES('Giro','2010','MARIO ROSSI','SECONDO')
INSERT INTO PARTECIPA VALUES('Giro','2010','BRADLEY WIGGINS','PRIMO')


/*
Visualizzo il contenuto delle tabelle
*/

SELECT * FROM CICLISTA
SELECT * FROM GARA
SELECT * FROM PARTECIPA

/*
Nel seguito si riportano le soluzioni delle query numerate come sul libro
*/

/*
a) selezionare i ciclisti che si sono classificati in prima posizione in una gara ciclistica 
	partita da Milano
*/

SELECT *
FROM GARA,PARTECIPA
WHERE GARA.PARTENZA='MILANO'
AND GARA.NOMECORSA=PARTECIPA.NOMECORSA AND
GARA.ANNO=PARTECIPA.ANNO AND PARTECIPA.POSIZIONE='PRIMO'


/*
b) selezionare il nome dei ciclisti che non si sono mai ritirati al Giro
*/

/*Soluzione del libro*/
SELECT *
FROM CICLISTA
WHERE NOMECICLISTA NOT IN (SELECT NOMECICLISTA
							FROM PARTECIPA
							WHERE NOMECORSA='GIRO'
							AND POSIZIONE='R')

/*soluzione alternativa*/

SELECT *
FROM CICLISTA C
WHERE NOT EXISTS (SELECT *
					FROM PARTECIPA AS P
					WHERE C.NOMECICLISTA=P.NOMECICLISTA
					AND NOMECORSA='GIRO'
					AND P.POSIZIONE='R')
					
					
/*
c) selezionare le corse per le quali in ogni edizione c'è stato almeno un ritirato
*/

SELECT DISTINCT NOMECORSA
FROM GARA G1
WHERE NOT EXISTS ( SELECT *
					FROM GARA G2
					WHERE G1.NOMECORSA=G2.NOMECORSA
					AND NOT EXISTS ( SELECT *
										FROM PARTECIPA P
										WHERE G2.NOMECORSA=P.NOMECORSA
										AND G2.ANNO=P.ANNO
										AND P.POSIZIONE='R'))
										
										
										
/*
d) selezionare, per ogni corsa ciclistica, l'anno un cui c'è stato il maggior numero di ciclisti ritirati
*/

SELECT NOMECORSA,ANNO
FROM PARTECIPA P1
WHERE P1.POSIZIONE='R'
GROUP BY NOMECORSA,ANNO
HAVING COUNT(*) >= ALL (SELECT COUNT(*)
						FROM PARTECIPA P2
						WHERE P2.POSIZIONE='R'
						AND P2.NOMECORSA=P1.NOMECORSA
						GROUP BY ANNO)